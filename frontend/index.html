<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웹툰 서비스</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .filter-buttons {
            text-align: center;
            margin-bottom: 30px;
        }
        .filter-buttons button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        .filter-buttons button:hover {
            background: #5568d3;
        }
        .webtoon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .webtoon-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .webtoon-card img {
            width: 100%;
            border-radius: 8px;
            aspect-ratio: 3/4;
            object-fit: cover;
        }
        .webtoon-card h3 {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }
        .webtoon-card p {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .top-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #ffffffcc;
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-weight: 700;
            font-size: 18px;
            color: #4f46e5;
            text-decoration: none;
        }
        .nav-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .nav-link {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 13px;
            text-decoration: none;
            color: #4b5563;
        }
        .nav-link:hover {
            background: #eef2ff;
            color: #4f46e5;
        }
        .nav-button {
            padding: 6px 12px;
            border-radius: 999px;
            border: none;
            background: #4f46e5;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        .nav-button:hover {
            background: #4338ca;
        }
        .thumb-wrapper {
            position: relative;
        }
        .thumb-wrapper img {
            width: 100%;
            display: block;
            border-radius: 8px;
        }
        .fav-icon {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.45);
            color: #ffffff;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .fav-icon.on {
            background: #fbbf24;   /* 노란색 배경 */
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="nav-left">
            <a href="index.html" class="logo">웹툰 서비스</a>
        </div>
        <div class="nav-right">
            <a href="index.html" class="nav-link">홈</a>
            <a href="mypage.html" class="nav-link">마이페이지</a>
            <a href="login.html" class="nav-link" id="login-link">로그인</a>
            <button id="logout-btn" class="nav-button" style="display:none;">로그아웃</button>
        </div>
    </div>

    <h1>웹툰 서비스</h1>
    
    <div class="filter-buttons">
        <button onclick="loadWebtoons('NAVER')">네이버</button>
        <button onclick="loadWebtoons('KAKAO')">카카오</button>
        <button onclick="loadWebtoons('KAKAOPAGE')">카카오페이지</button>
    </div>

    <div id="webtoon-grid" class="webtoon-grid">
        <div class="loading">웹툰을 불러오는 중...</div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function apiCall(path, options = {}) {
            const res = await fetch(`${API_BASE}${path}`, {
                credentials: 'include',                  // 세션 쿠키 포함
                headers: { 'Content-Type': 'application/json' },
                ...options,
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`API ${res.status}: ${text}`);
            }
            return res.json();
        }

        const Api = {
            getWebtoons: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return apiCall(`/webtoons/${query ? '?' + query : ''}`);
            },
            toggleFavorite: (id) =>
                apiCall(`/webtoons/${id}/favorite/`, { method: 'POST' }),
        };

        function renderWebtoons(data) {
            const grid = document.getElementById('webtoon-grid');
            grid.innerHTML = '';

            data.results.forEach(toon => {
                const card = document.createElement('div');
                card.className = 'webtoon-card';
                card.innerHTML = `
                    <div class="thumb-wrapper">
                        <a href="${toon.url}" target="_blank">
                            <img src="${toon.thumbnail}" alt="${toon.title}">
                        </a>
                        <button class="fav-icon ${toon.is_favorited ? 'on' : ''}" data-id="${toon.id}">
                            ★
                        </button>
                    </div>
                    <h3>${toon.title}</h3>
                    <p>${toon.wirters}</p>
                    <p style="color: #947dff; font-size: 13px;">${toon.update_days}</p>
                `;
                grid.appendChild(card);
            });

            // 즐겨찾기 토글
            grid.addEventListener('click', async (e) => {
                const btn = e.target.closest('.fav-icon');
                if (!btn) return;

                const id = btn.dataset.id;
                const csrftoken = getCookie('csrftoken');

                try {
                    const response = await fetch(`http://127.0.0.1:8000/api/webtoons/${id}/favorite/`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken || '',
                        },
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('로그인이 필요합니다.');
                            return;
                        }
                        throw new Error(await response.text());
                    }

                    const result = await response.json();
                    if (result.is_favorited) {
                        btn.classList.add('on');
                    } else {
                        btn.classList.remove('on');
                    }
                } catch (err) {
                    console.error(err);
                    alert('즐겨찾기 처리 중 오류가 발생했습니다.');
                }
            });
        }

        async function loadWebtoons(provider, page = 1) {
            const grid = document.getElementById('webtoon-grid');
            grid.innerHTML = '<div class="loading">불러오는 중...</div>';

            try {
                const data = await Api.getWebtoons({
                    provider,
                    page,
                    per_page: 100,
                });

                if (!data.results.length) {
                    grid.innerHTML = '<div class="loading">웹툰이 없습니다.</div>';
                    return;
                }

                renderWebtoons(data);           // 여기서 카드/즐겨찾기까지 처리
                console.log(`전체 ${data.count}개 중 ${page}/${data.total_pages} 페이지`);
            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = '<div class="loading">오류가 발생했습니다.</div>';
            }
        }

        // 페이지 로드 시 네이버 웹툰 표시
        loadWebtoons('NAVER');
        // 현재 로그인 상태 확인해서 네비 업데이트
        async function updateNavAuth() {
            const loginLink = document.getElementById('login-link');
            const logoutBtn = document.getElementById('logout-btn');
            if (!loginLink || !logoutBtn) return;

            try {
                const res = await fetch(`${API_BASE}/accounts/me/`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'X-CSRFToken': getCookie('csrftoken') || '',
                    },
                });

                if (res.ok) {
                    // 로그인 상태
                    loginLink.style.display = 'none';
                    logoutBtn.style.display = 'inline-flex';
                } else {
                    // 비로그인 상태
                    loginLink.style.display = 'inline-flex';
                    logoutBtn.style.display = 'none';
                }
            } catch (err) {
                console.error('auth check error:', err);
                loginLink.style.display = 'inline-flex';
                logoutBtn.style.display = 'none';
            }
        }

        // 로그아웃 클릭 시 처리
        async function handleLogout() {
            try {
                const res = await fetch(`${API_BASE}/accounts/logout/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || '',
                    },
                });
                // 어차피 세션만 날리면 되니까 상태코드 상관없이 메인으로
            } catch (err) {
                console.error('logout error:', err);
            } finally {
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            updateNavAuth();
        });
    </script>
</body>
</html>
